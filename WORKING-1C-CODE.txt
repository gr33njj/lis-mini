// ==================== СКОПИРУЙТЕ ВЕСЬ ЭТОТ КОД В МОДУЛЬ HTTP-СЕРВИСА ====================
// Замените ВСЁ содержимое модуля этим кодом!

// Метод test - простая проверка
Функция testPOST(Запрос)
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.Заголовки.Вставить("Content-Type", "application/json");
    Ответ.УстановитьТелоИзСтроки("{""status"":""ok"",""message"":""test works""}");
    Возврат Ответ;
КонецФункции

// Метод echo - эхо
Функция echoPOST(Запрос)
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.Заголовки.Вставить("Content-Type", "application/json");
    
    Попытка
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
        Ответ.УстановитьТелоИзСтроки(ТелоЗапроса);
    Исключение
        Ответ.КодСостояния = 500;
        Ответ.УстановитьТелоИзСтроки("{""error"":""" + ОписаниеОшибки() + """}");
    КонецПопытки;
    
    Возврат Ответ;
КонецФункции

// Основной метод - прикрепление результатов
Функция attachResultPOST(Запрос)
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.Заголовки.Вставить("Content-Type", "application/json");
    
    Попытка
        // Читаем JSON
        ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();
        
        Если ПустаяСтрока(ТелоЗапроса) Тогда
            Ответ.КодСостояния = 400;
            Ответ.УстановитьТелоИзСтроки("{""error"":""Empty body""}");
            Возврат Ответ;
        КонецЕсли;
        
        // Парсим JSON
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);
        Данные = ПрочитатьJSON(ЧтениеJSON);
        ЧтениеJSON.Закрыть();
        
        // Получаем поля
        НомерЗаказа = "";
        ИмяФайла = "";
        ФайлBase64 = "";
        
        Если ТипЗнч(Данные) = Тип("Соответствие") Тогда
            НомерЗаказа = Данные.Получить("orderNo");
            ИмяФайла = Данные.Получить("fileName");
            ФайлBase64 = Данные.Получить("fileBase64");
        ИначеЕсли ТипЗнч(Данные) = Тип("Структура") Тогда
            Если Данные.Свойство("orderNo", НомерЗаказа) Тогда КонецЕсли;
            Если Данные.Свойство("fileName", ИмяФайла) Тогда КонецЕсли;
            Если Данные.Свойство("fileBase64", ФайлBase64) Тогда КонецЕсли;
        КонецЕсли;
        
        // Проверка
        Если ПустаяСтрока(НомерЗаказа) Тогда
            Ответ.КодСостояния = 400;
            Ответ.УстановитьТелоИзСтроки("{""error"":""orderNo required""}");
            Возврат Ответ;
        КонецЕсли;
        
        // Ищем заказ
        Запрос1С = Новый Запрос;
        Запрос1С.Текст = 
        "ВЫБРАТЬ ПЕРВЫЕ 1
        |    ЗаказыНаИсследования.Ссылка КАК Ссылка
        |ИЗ
        |    Документ.ЗаказНаИсследование КАК ЗаказыНаИсследования
        |ГДЕ
        |    ЗаказыНаИсследования.НомерИсследования = &НомерИсследования";
        
        Запрос1С.УстановитьПараметр("НомерИсследования", НомерЗаказа);
        Результат1С = Запрос1С.Выполнить();
        
        Если Результат1С.Пустой() Тогда
            Ответ.КодСостояния = 404;
            Ответ.УстановитьТелоИзСтроки("{""error"":""Order not found"",""orderNo"":""" + НомерЗаказа + """}");
            Возврат Ответ;
        КонецЕсли;
        
        // Заказ найден!
        Ответ.УстановитьТелоИзСтроки("{""status"":""ok"",""message"":""Order found"",""orderNo"":""" + НомерЗаказа + """}");
        
    Исключение
        Ответ.КодСостояния = 500;
        ТекстОшибки = СтрЗаменить(ОписаниеОшибки(), """", """""");
        Ответ.УстановитьТелоИзСтроки("{""error"":""" + ТекстОшибки + """}");
    КонецПопытки;
    
    Возврат Ответ;
КонецФункции

// GET метод
Функция ОбработкаGET(Запрос)
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.УстановитьТелоИзСтроки("LIS Integration Service OK");
    Возврат Ответ;
КонецФункции

// ==================== КОНЕЦ КОДА ====================

