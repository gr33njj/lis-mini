# Интеграция с 1С:Управление медицинским центром (ПервыйБит)

## Описание

Данный документ описывает настройку HTTP-сервиса в 1С для приема результатов анализов от системы ЛИС МД.

## Требования

- 1С:Предприятие 8.3 (любая редакция)
- Конфигурация "Управление медицинским центром" от ПервыйБит
- Настроенная публикация HTTP-сервисов

## Архитектура взаимодействия

```
ЛИС МД (185.247.185.145) 
    ↓ OpenVPN туннель
Локальная сеть офиса (192.168.100.0/24)
    ↓ HTTP POST
1С Сервер (192.168.100.234)
```

## Настройка HTTP-сервиса в 1С

### 1. Создание HTTP-сервиса

1. Откройте конфигурацию в режиме Конфигуратора
2. Создайте новый HTTP-сервис: `Общие` → `HTTP-сервисы` → `Добавить`
3. Имя: `LabIntegration`
4. Корневой URL: `lab`

### 2. Добавление метода `attachResult`

**URL шаблон:** `attachResult`  
**HTTP метод:** `POST`  
**Обработчик:** Модуль HTTP-сервиса

### 3. Код обработчика

```1c
// HTTP-сервис: LabIntegration
// Метод: attachResult

Функция attachResultPOST(Запрос)
    
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.Заголовки.Вставить("Content-Type", "application/json");
    
    Попытка
        // Проверка авторизации
        ТокенАвторизации = Запрос.Заголовки.Получить("Authorization");
        Если Не ПроверитьТокен(ТокенАвторизации) Тогда
            Ответ.КодСостояния = 401;
            Ответ.УстановитьТелоИзСтроки("{ ""error"": ""Unauthorized"" }");
            Возврат Ответ;
        КонецЕсли;
        
        // Получение данных запроса
        ДанныеЗапроса = ПрочитатьJSONВЗначение(Запрос.ПолучитьТелоКакСтроку());
        
        НомерЗаказа = ДанныеЗапроса.Получить("orderNo");
        ИмяФайла = ДанныеЗапроса.Получить("fileName");
        ФайлBase64 = ДанныеЗапроса.Получить("fileBase64");
        ОтправитьEmail = ДанныеЗапроса.Получить("sendEmail");
        
        // Валидация
        Если ПустаяСтрока(НомерЗаказа) Тогда
            ВызватьИсключение "Не указан номер заказа";
        КонецЕсли;
        
        Если ПустаяСтрока(ФайлBase64) Тогда
            ВызватьИсключение "Не передан файл";
        КонецЕсли;
        
        // Поиск заказа по номеру исследования
        Заказ = НайтиЗаказПоНомеру(НомерЗаказа);
        
        Если Заказ = Неопределено Тогда
            Ответ.КодСостояния = 404;
            Ответ.УстановитьТелоИзСтроки(
                "{ ""error"": ""Заказ не найден"", ""orderNo"": """ + НомерЗаказа + """ }"
            );
            Возврат Ответ;
        КонецЕсли;
        
        // Декодирование файла
        ДвоичныеДанные = Base64Значение(ФайлBase64);
        
        // Проверка на дубликат (по хешу)
        ЕстьДубликат = ПроверитьДубликатФайла(Заказ, ДвоичныеДанные);
        
        Если ЕстьДубликат Тогда
            Ответ.УстановитьТелоИзСтроки(
                "{ ""status"": ""ok"", ""message"": ""Файл уже прикреплен (дубликат)"", ""alreadyAttached"": true }"
            );
            Возврат Ответ;
        КонецЕсли;
        
        // Создание документа "Результат исследования"
        ДокРезультат = Документы.РезультатИсследования.СоздатьДокумент();
        ДокРезультат.Заказ = Заказ;
        ДокРезультат.Дата = ТекущаяДата();
        
        // Прикрепление файла
        ПрисоединенныйФайл = ПрисоединенныеФайлы.СоздатьПрисоединенныйФайл();
        ПрисоединенныйФайл.Владелец = ДокРезультат.Ссылка;
        ПрисоединенныйФайл.ИмяФайла = ИмяФайла;
        ПрисоединенныйФайл.Записать(ДвоичныеДанные);
        
        // Запись документа
        ДокРезультат.Записать(РежимЗаписиДокумента.Проведение);
        
        // Получение email пациента
        EmailПациента = ПолучитьEmailПациента(Заказ);
        
        // Отправка email (если требуется)
        Если ОтправитьEmail = Истина И Не ПустаяСтрока(EmailПациента) Тогда
            ОтправитьРезультатПоEmail(EmailПациента, ДокРезультат, ДвоичныеДанные, ИмяФайла);
        КонецЕсли;
        
        // Формирование ответа
        РезультатJSON = Новый Структура;
        РезультатJSON.Вставить("status", "ok");
        РезультатJSON.Вставить("docRef", Строка(ДокРезультат.Ссылка.УникальныйИдентификатор()));
        РезультатJSON.Вставить("email", EmailПациента);
        РезультатJSON.Вставить("alreadyAttached", Ложь);
        
        Ответ.УстановитьТелоИзСтроки(ЗаписатьJSONВСтроку(РезультатJSON));
        
    Исключение
        Ответ.КодСостояния = 500;
        ОписаниеОшибки = ОписаниеОшибки();
        
        СтруктураОшибки = Новый Структура;
        СтруктураОшибки.Вставить("error", ОписаниеОшибки);
        
        Ответ.УстановитьТелоИзСтроки(ЗаписатьJSONВСтроку(СтруктураОшибки));
        
        // Логирование ошибки
        ЗаписатьЛогСобытий("ЛИС.ПриемРезультатов", 
            УровеньЛогаСобытий.Ошибка, 
            , 
            , 
            ОписаниеОшибки);
    КонецПопытки;
    
    Возврат Ответ;
    
КонецФункции

// Вспомогательные функции

Функция ПроверитьТокен(ТокенАвторизации)
    
    // Получаем настройку токена из константы
    ОжидаемыйТокен = Константы.ЛИС_ТокенАвторизации.Получить();
    
    Если ПустаяСтрока(ОжидаемыйТокен) Тогда
        // Если токен не настроен, разрешаем доступ (небезопасно!)
        Возврат Истина;
    КонецЕсли;
    
    // Проверка формата "Bearer TOKEN"
    Если СтрНачинаетсяС(ТокенАвторизации, "Bearer ") Тогда
        Токен = Сред(ТокенАвторизации, 8);
        Возврат Токен = ОжидаемыйТокен;
    КонецЕсли;
    
    Возврат Ложь;
    
КонецФункции

Функция НайтиЗаказПоНомеру(НомерЗаказа)
    
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |    ЗаказыНаИсследования.Ссылка КАК Ссылка
    |ИЗ
    |    Документ.ЗаказНаИсследование КАК ЗаказыНаИсследования
    |ГДЕ
    |    ЗаказыНаИсследования.НомерИсследования = &НомерИсследования
    |    И НЕ ЗаказыНаИсследования.ПометкаУдаления";
    
    Запрос.УстановитьПараметр("НомерИсследования", НомерЗаказа);
    
    Результат = Запрос.Выполнить();
    
    Если Результат.Пустой() Тогда
        Возврат Неопределено;
    КонецЕсли;
    
    Выборка = Результат.Выбрать();
    Выборка.Следующий();
    
    Возврат Выборка.Ссылка;
    
КонецФункции

Функция ПолучитьEmailПациента(Заказ)
    
    ЗаказОбъект = Заказ.ПолучитьОбъект();
    
    Если ЗаказОбъект.Пациент = Неопределено Тогда
        Возврат "";
    КонецЕсли;
    
    // Получаем контактную информацию пациента
    КонтактнаяИнформация = РегистрыСведений.КонтактнаяИнформация.СоздатьНаборЗаписей();
    КонтактнаяИнформация.Отбор.Объект.Установить(ЗаказОбъект.Пациент);
    КонтактнаяИнформация.Прочитать();
    
    Для Каждого Запись Из КонтактнаяИнформация Цикл
        Если Запись.Тип = Перечисления.ТипыКонтактнойИнформации.АдресЭлектроннойПочты Тогда
            Возврат Запись.Представление;
        КонецЕсли;
    КонецЦикла;
    
    Возврат "";
    
КонецФункции

Функция ПроверитьДубликатФайла(Заказ, ДвоичныеДанные)
    
    // Вычисляем хеш файла
    Хеширование = Новый ХешированиеДанных(ХешФункция.SHA256);
    Хеширование.Добавить(ДвоичныеДанные);
    ХешФайла = Хеширование.ХешСумма;
    ХешСтрокой = СтрЗаменить(Строка(ХешФайла), " ", "");
    
    // Проверяем в регистре сведений
    Запрос = Новый Запрос;
    Запрос.Текст = 
    "ВЫБРАТЬ ПЕРВЫЕ 1
    |    ХешиФайловРезультатов.Ссылка
    |ИЗ
    |    РегистрСведений.ХешиФайловРезультатов КАК ХешиФайловРезультатов
    |ГДЕ
    |    ХешиФайловРезультатов.Заказ = &Заказ
    |    И ХешиФайловРезультатов.ХешФайла = &ХешФайла";
    
    Запрос.УстановитьПараметр("Заказ", Заказ);
    Запрос.УстановитьПараметр("ХешФайла", ХешСтрокой);
    
    Результат = Запрос.Выполнить();
    
    Если НЕ Результат.Пустой() Тогда
        Возврат Истина;
    КонецЕсли;
    
    // Записываем хеш
    Менеджер = РегистрыСведений.ХешиФайловРезультатов.СоздатьМенеджерЗаписи();
    Менеджер.Заказ = Заказ;
    Менеджер.ХешФайла = ХешСтрокой;
    Менеджер.ДатаЗагрузки = ТекущаяДата();
    Менеджер.Записать();
    
    Возврат Ложь;
    
КонецФункции

Функция ОтправитьРезультатПоEmail(Email, Документ, ДвоичныеДанные, ИмяФайла)
    
    // Реализация отправки email через настроенный почтовый сервер
    // Код зависит от конфигурации
    
    // Пример:
    Попытка
        ПараметрыПочты = ПолучитьПараметрыПочты();
        
        Письмо = Новый ИнтернетПочтовоеСообщение;
        Письмо.Кому.Добавить(Email);
        Письмо.Тема = "Результат анализа готов";
        Письмо.Тексты.Добавить(
            "Здравствуйте!" + Символы.ПС + Символы.ПС +
            "Ваш результат анализа готов." + Символы.ПС +
            "Результаты прикреплены к данному письму." + Символы.ПС + Символы.ПС +
            "С уважением," + Символы.ПС +
            "Медицинский центр"
        );
        
        // Прикрепляем файл
        Вложение = Письмо.Вложения.Добавить(ДвоичныеДанные, ИмяФайла);
        
        // Отправка
        Почта = Новый ИнтернетПочта;
        Почта.Подключиться(ПараметрыПочты);
        Почта.Отправить(Письмо);
        Почта.Отключиться();
        
        Возврат Истина;
        
    Исключение
        ЗаписатьЛогСобытий("ЛИС.ОтправкаEmail", 
            УровеньЛогаСобытий.Ошибка, 
            , 
            Email, 
            ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
КонецФункции

Функция ПрочитатьJSONВЗначение(СтрокаJSON)
    
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(СтрокаJSON);
    
    Возврат ПрочитатьJSON(ЧтениеJSON, Истина);
    
КонецФункции

Функция ЗаписатьJSONВСтроку(Данные)
    
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, Данные);
    
    Возврат ЗаписьJSON.Закрыть();
    
КонецФункции
```

## Настройка публикации

### 1. Публикация HTTP-сервиса

1. `Администрирование` → `Публикация на веб-сервере`
2. Добавьте HTTP-сервис `LabIntegration`
3. Корневой URL: `lab`

### 2. Настройка веб-сервера (IIS или Apache)

#### Для IIS:

Создайте новый сайт или виртуальную директорию, указывающую на публикацию 1С.

URL будет иметь вид:
```
http://192.168.100.234/УправлениеМЦ/hs/lab/attachResult
```

#### Для Apache (с использованием mod_proxy):

```apache
<VirtualHost *:80>
    ServerName 192.168.100.234
    
    ProxyPass /УправлениеМЦ http://localhost:PORT/УправлениеМЦ
    ProxyPassReverse /УправлениеМЦ http://localhost:PORT/УправлениеМЦ
</VirtualHost>
```

## Настройка авторизации

### 1. Создайте константу для хранения токена

`Общие` → `Константы` → `Создать`

- Имя: `ЛИС_ТокенАвторизации`
- Тип: Строка (255)

### 2. Сгенерируйте безопасный токен

В командной строке Linux:
```bash
openssl rand -hex 32
```

Сохраните этот токен в:
- Константе 1С: `ЛИС_ТокенАвторизации`
- Файле `.env` сервера ЛИС МД: `API_1C_TOKEN`

## Создание регистра сведений для хешей

Для предотвращения дубликатов создайте регистр сведений:

`Общие` → `Регистры сведений` → `Создать`

- Имя: `ХешиФайловРезультатов`
- Периодичность: Нет
- Измерения:
  - `Заказ` (ДокументСсылка.ЗаказНаИсследование)
  - `ХешФайла` (Строка, 64)
- Ресурсы:
  - `ДатаЗагрузки` (Дата)

## Тестирование интеграции

### Проверка доступности API

С сервера ЛИС МД:

```bash
curl http://192.168.100.234/УправлениеМЦ/hs/lab/attachResult \
  -H "Authorization: Bearer your_token_here" \
  -H "Content-Type: application/json" \
  -d '{}'
```

Ожидаемый ответ (ошибка - это нормально для пустого запроса):
```json
{"error": "Не указан номер заказа"}
```

### Полный тест с файлом

```bash
# Создайте тестовый PDF в base64
base64 test.pdf > test.b64

# Отправьте запрос
curl http://192.168.100.234/УправлениеМЦ/hs/lab/attachResult \
  -H "Authorization: Bearer your_token_here" \
  -H "Content-Type: application/json" \
  -d '{
    "orderNo": "123456",
    "fileName": "123456.pdf",
    "fileBase64": "'$(cat test.b64)'",
    "sendEmail": true
  }'
```

## Мониторинг и логирование

### В 1С

Все операции логируются в журнал регистрации с префиксом "ЛИС":
- `ЛИС.ПриемРезультатов` - прием файлов
- `ЛИС.ОтправкаEmail` - отправка email

### Просмотр логов

`Администрирование` → `Журнал регистрации`

Фильтр: События начинаются с "ЛИС"

## Структура данных

### Запрос (POST)

```json
{
  "orderNo": "123456",
  "fileName": "123456.pdf",
  "fileBase64": "JVBERi0xLjQKJeLjz9MKMSAwIG9iago...",
  "sendEmail": true
}
```

### Ответ (успешный)

```json
{
  "status": "ok",
  "docRef": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "email": "patient@example.com",
  "alreadyAttached": false
}
```

### Ответ (ошибка)

```json
{
  "error": "Описание ошибки"
}
```

## Безопасность

1. **Используйте HTTPS в продакшене**
   - Установите SSL сертификат на веб-сервер 1С
   - Обновите `API_1C_URL` на `https://`

2. **Защитите токен авторизации**
   - Храните токен в безопасном месте
   - Периодически меняйте токен
   - Не сохраняйте токен в коде

3. **Ограничьте доступ по IP**
   - Настройте фаервол, разрешив доступ только с IP OpenVPN туннеля

4. **Мониторьте логи**
   - Регулярно проверяйте журнал регистрации на подозрительную активность

## Поддержка

При возникновении проблем проверьте:

1. Доступность 1С сервера через OpenVPN
2. Правильность URL и токена
3. Логи в журнале регистрации 1С
4. Логи ЛИС МД: `docker-compose logs -f app`

